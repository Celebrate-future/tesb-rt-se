<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:u="http://www.springframework.org/schema/util"
       xsi:schemaLocation="
            http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd
            http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

    <bean id="activemq" class="org.apache.activemq.camel.component.ActiveMQComponent" depends-on="camel">
        <property name="brokerURL" value="vm://localhost?broker.persistent=false"/>
    </bean>

    <bean id="stock" class="org.apache.camel.example.management.StockService" depends-on="camel">
        <property name="symbols" ref="symbols"/>
    </bean>

    <u:list id="symbols" value-type="java.lang.String">
        <value>IBM</value>
        <value>APPLE</value>
        <value>JAVA</value>
    </u:list>

    <camelContext id="camel" xmlns="http://camel.apache.org/schema/spring">
        <!-- Default JMX connector url: "service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi/camel" -->

        <route>
            <from uri="timer://inbox?period=5000"/>
            <bean ref="stock" method="createRandomStocks"/>
            <to uri="file://target/inbox"/>
        </route>

        <route>
            <from uri="file://target/inbox"/>
            <split>
                <xpath>/stocks/stock</xpath>
                <throttle timePeriodMillis="1000" maximumRequestsPerPeriod="10">
                    <to uri="activemq:queue:stock"/>
                </throttle>
            </split>
        </route>

        <route>
            <from uri="activemq:queue:stock"/>
            <delay><constant>100</constant></delay>
            <bean ref="stock" method="transform"/>
            <to uri="log:stocks?groupSize=100"/>
        </route>

    </camelContext>

</beans>
