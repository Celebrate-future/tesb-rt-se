<!--
    Copyright (C) 2011 Talend Inc. - www.talend.com
-->
<beans 
    xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:jaxws="http://cxf.apache.org/jaxws"
    xmlns:util="http://www.springframework.org/schema/util"
    xmlns:osgix="http://www.springframework.org/schema/osgi-compendium"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://cxf.apache.org/jaxws http://cxf.apache.org/schemas/jaxws.xsd
        http://www.springframework.org/schema/osgi-compendium http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd">

    <bean id="utSTSProviderBean"
        class="org.apache.cxf.ws.security.sts.provider.SecurityTokenServiceProvider">
        <property name="issueOperation" ref="utIssueDelegate"/>
        <property name="validateOperation" ref="utValidateDelegate"/>
    </bean> 

    <bean id="utIssueDelegate"
        class="org.apache.cxf.sts.operation.TokenIssueOperation">
        <property name="tokenProviders" ref="utSamlTokenProvider"/>
        <property name="services" ref="utService"/>
        <property name="stsProperties" ref="utSTSProperties"/>
    </bean>

    <bean id="utValidateDelegate"
        class="org.apache.cxf.sts.operation.TokenValidateOperation">
        <property name="tokenValidators" ref="utSamlTokenValidator"/>
        <property name="stsProperties" ref="utSTSProperties"/>
    </bean>

    <bean id="utSamlTokenProvider"
        class="org.apache.cxf.sts.token.provider.SAMLTokenProvider">
    </bean>

    <bean id="utSamlTokenValidator"
        class="org.apache.cxf.sts.token.validator.SAMLTokenValidator">
    </bean>

    <bean id="utService"
        class="org.apache.cxf.sts.service.StaticService">
        <property name="endpoints">
            <list>
                <value>.*</value>
            </list>
        </property>
    </bean>

    <!-- Configuration Admin entry -->
    <osgix:cm-properties id="sts-server-config" persistent-id="org.talend.esb.sts.server"/>
    <!-- placeholder configurer -->
    <bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="properties" ref="sts-server-config" />
        <property name="placeholderPrefix" value="$sts{" />
    </bean>

    <bean id="utSTSProperties"
         class="org.apache.cxf.sts.StaticSTSProperties">
        <property name="signaturePropertiesFile" value="$sts{signatureProperties}"/>
        <property name="signatureUsername" value="$sts{signatureUsername}"/>
        <property name="callbackHandlerClass" value="org.talend.esb.sts.callback.PasswordCallbackHandler"/>
        <!--property name="encryptionPropertiesFile" value="$sts{encryptionProperties}"/>
        <property name="encryptionUsername" value="$sts{encryptionUsername}"/-->
    </bean>

    <bean class="org.apache.ws.security.validate.JAASUsernameTokenValidator" id="jaasUTValidator">
        <property name="contextName" value="$sts{jaasContext}" /> 
    </bean>

    <jaxws:endpoint id="UTSTS"
        implementor="#utSTSProviderBean"
        address="$sts{stsServiceUrl}" 
        wsdlLocation="ws-trust-1.4-service.wsdl"
        xmlns:ns1="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
        serviceName="ns1:SecurityTokenService"
        endpointName="ns1:UT_Port">
        <jaxws:properties>
            <entry key="ws-security.callback-handler" value="org.talend.esb.sts.callback.PasswordCallbackHandler"/>
            <entry key="ws-security.ut.validator" value-ref="jaasUTValidator" />
            <entry key="ws-security.signature.properties" value="$sts{signatureProperties}"/>
            <entry key="ws-security.signature.username" value="$sts{signatureUsername}"/>
            <!-- Below needs to be set to non-default value of false for Metro clients -->
            <entry key="ws-security.is-bsp-compliant" value="$sts{bspCompliant}"/>
        </jaxws:properties> 
    </jaxws:endpoint>

</beans>
